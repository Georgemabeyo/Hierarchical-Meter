<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Meter Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#e6f2ff; }
.sidebar { height:100vh; background:linear-gradient(180deg,#007bff,#0056b3); color:white; padding-top:20px; position:fixed; left:0; top:0; width:220px; transition:width 0.3s; z-index:1000; }
.sidebar.collapsed { width:60px; text-align:center; }
.sidebar h4 { text-align:center; font-weight:bold; margin-bottom:20px; }
.sidebar.collapsed h4 { display:none; }
.sidebar a { display:block; color:white; padding:12px 20px; text-decoration:none; margin:5px 10px; border-radius:8px; transition:all 0.3s; }
.sidebar a:hover { background-color: rgba(255,255,255,0.3); transform:scale(1.05); }
.main-content { margin-left:240px; padding:20px; transition:margin-left 0.3s; }
.main-content.expanded { margin-left:70px; }
.card { border:none; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.15); transition:transform 0.3s, box-shadow 0.3s; }
.card:hover { transform:translateY(-7px); box-shadow:0 12px 30px rgba(0,0,0,0.25); }
.alert-sign { font-weight:bold; color:white; padding:5px 12px; border-radius:25px; font-size:0.9rem; display:inline-block; min-width:70px; text-align:center; }
.normal { background-color:#6fcf97; }
.abnormal { background-color:#ff4c4c; }
table tbody tr:hover { background-color:#d9edf7; cursor:pointer; }
.page { display:none; }
.page.active { display:block; }
#searchInput { margin-bottom:15px; border-radius:25px; }
@media(max-width:768px){ .main-content{margin-left:70px;padding:15px;} .sidebar{width:70px;} .sidebar a{font-size:0.8rem;padding:10px 12px;} }
.card-gradient { background: linear-gradient(135deg,#00c6ff,#0072ff); color:white; }
.abnormal-cell { background-color:rgba(255,76,76,0.2); }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h4>ðŸ’§ Water Admin</h4>
    <button class="btn btn-light btn-sm mb-3 w-75 mx-auto" id="toggleSidebar">â˜°</button>
    <a href="#" data-page="dashboard">ðŸ“Š Dashboard</a>
    <a href="#" data-page="meters">ðŸ“‹ Meters</a>
</div>

<div class="main-content" id="mainContent">

    <!-- Dashboard -->
    <div id="dashboard" class="page active">
        <h3>ðŸ“Š Individual Meter Summary</h3>
        <div class="row g-3 mb-4" id="meterSummaryCards"></div>
        <div class="row g-3 mt-4">
            <div class="col-12">
                <div class="card p-4">
                    <h5>ðŸ“Š Rooms Status Summary (Normal vs Abnormal)</h5>
                    <canvas id="summaryChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Meters Page -->
    <div id="meters" class="page">
        <h3>ðŸ“‹ Meters & Tenants</h3>
        <input type="text" id="searchInput" class="form-control" placeholder="Search Meter, Room or Tenant...">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Meter ID</th>
                        <th>Room ID</th>
                        <th>Tenant</th>
                        <th>Total Liters (Till Today)</th>
                        <th>Status</th>
                        <th>Cost (Tsh)</th>
                    </tr>
                </thead>
                <tbody id="meterTable"></tbody>
            </table>
        </div>
        <div class="card p-3 mt-4 card-gradient">
            <h5>ðŸ“Š Selected Tenant Usage Trend</h5>
            <label for="daySelect" class="form-label mt-2">Select Date:</label>
            <select id="daySelect" class="form-select mb-3"></select>
            <canvas id="roomChart" height="100"></canvas>
        </div>
    </div>

</div>

<script>
const PRICE_PER_LITER = 1.6;
let meters = [];  // will be populated from API
let selectedRoom=null;

// Populate daySelect
const daySelect = document.getElementById("daySelect");
const today = new Date();
const monthDates = Array.from({length:30},(_,i)=>{
    const d=new Date(today.getFullYear(), today.getMonth(), i+1);
    const opt=document.createElement("option");
    opt.value=i; opt.text=`${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
    daySelect.appendChild(opt);
    return `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
});

// Fetch sensor data
async function fetchSensorData(){
    try {
        const res = await fetch('api/data.json'); // change to your sensor URL
        const data = await res.json();
        meters = data.meters;
        if(!selectedRoom && meters.length>0) selectedRoom=meters[0];
        renderTable();
        renderSummaryChart();
        if(selectedRoom) showRoomGraph(selectedRoom.meter_id);
    } catch(err){
        console.error('Failed to fetch sensor data', err);
    }
}

// Status
function getStatus(usageHistory, dayIndex){
    const totalSoFar = usageHistory.slice(0, dayIndex+1).reduce((a,b)=>a+b,0);
    const avgSoFar = totalSoFar / (dayIndex+1);
    return usageHistory[dayIndex] > avgSoFar ? "abnormal" : "normal";
}

// Render Table
function renderTable(filter=""){
    const dayIndex = parseInt(daySelect.value) || 29;
    let table="";
    meters.forEach(m=>{
        if(m.meter_id.includes(filter) || m.room_id.includes(filter) || m.tenant.toLowerCase().includes(filter.toLowerCase())){
            const totalUsage = m.usageHistory.reduce((a,b)=>a+b,0);
            const statusClass = getStatus(m.usageHistory, dayIndex);
            const cost = (totalUsage*PRICE_PER_LITER).toFixed(2);
            table += `<tr onclick="showRoomGraph('${m.meter_id}')">
                <td>${m.meter_id}</td>
                <td>${m.room_id}</td>
                <td style="color:${statusClass==='abnormal'?'#b22222':'#2e8b57'}">${m.tenant}</td>
                <td class="${statusClass==='abnormal'?'abnormal-cell':''}">${totalUsage}</td>
                <td><span class="alert-sign ${statusClass}">${statusClass}</span></td>
                <td>${cost}</td>
            </tr>`;
        }
    });
    document.getElementById("meterTable").innerHTML = table;

    // Dashboard Cards
    const summaryContainer = document.getElementById("meterSummaryCards");
    summaryContainer.innerHTML = '';
    meters.forEach(m=>{
        const totalUsage = m.usageHistory.reduce((a,b)=>a+b,0);
        const card = `<div class="col-lg-3 col-md-4 col-sm-6">
          <div class="card p-4 text-center card-gradient">
            <h5>${m.tenant} (${m.meter_id})</h5>
            <h6>Room: ${m.room_id}</h6>
            <h6>Total Usage: ${totalUsage} L</h6>
            <h6>Cost: ${(totalUsage*PRICE_PER_LITER).toFixed(2)} Tsh</h6>
          </div></div>`;
        summaryContainer.innerHTML += card;
    });
}

// Room Chart
let roomChartInstance=null;
function showRoomGraph(meterId){
    selectedRoom = meters.find(m=>m.meter_id===meterId);
    if(!selectedRoom) return;
    const ctx=document.getElementById("roomChart").getContext("2d");
    if(roomChartInstance) roomChartInstance.destroy();
    const borderColors = selectedRoom.usageHistory.map((u,i)=>getStatus(selectedRoom.usageHistory,i)==="abnormal"?'#ff4c4c':'#6fcf97');
    const bgColors = selectedRoom.usageHistory.map((u,i)=>getStatus(selectedRoom.usageHistory,i)==="abnormal"?'rgba(255,76,76,0.3)':'rgba(111,207,151,0.3)');
    roomChartInstance=new Chart(ctx,{
        type:'line',
        data:{
            labels: monthDates,
            datasets:[{label:`${selectedRoom.tenant} (${selectedRoom.room_id})`, data:selectedRoom.usageHistory,
                borderColor:borderColors, backgroundColor:bgColors, fill:true, tension:0.3, pointRadius:5, pointHoverRadius:7}]
        },
        options:{responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
}

// Summary Chart
function renderSummaryChart(){
    const labels = meters.map(m=>m.tenant);
    const dayIndex = parseInt(daySelect.value) || 29;
    const normalCounts = meters.map(m=>getStatus(m.usageHistory, dayIndex)==="normal"?1:0);
    const abnormalCounts = meters.map(m=>getStatus(m.usageHistory, dayIndex)==="abnormal"?1:0);
    const ctxSummary = document.getElementById("summaryChart").getContext("2d");
    new Chart(ctxSummary,{
        type:'bar',
        data:{labels:labels,datasets:[
            {label:'Normal', data:normalCounts, backgroundColor:'#6fcf97'},
            {label:'Abnormal', data:abnormalCounts, backgroundColor:'#ff4c4c'}
        ]},
        options:{
            responsive:true,
            plugins:{
                legend:{display:true},
                tooltip:{
                    callbacks:{
                        label:function(context){
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            scales:{y:{beginAtZero:true, stepSize:1}}
        }
    });
}

// Event Listeners
daySelect.addEventListener("change", ()=>{ renderTable(document.getElementById("searchInput").value); renderSummaryChart(); });
document.getElementById("searchInput").addEventListener("input", function(){ renderTable(this.value); });
document.getElementById("toggleSidebar").addEventListener("click", ()=>{
    document.getElementById("sidebar").classList.toggle("collapsed");
    document.getElementById("mainContent").classList.toggle("expanded");
});
document.querySelectorAll('.sidebar a').forEach(link=>{
    link.addEventListener('click', e=>{
        e.preventDefault();
        const pageId = link.getAttribute('data-page');
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    });
});

// Initial fetch & update every 10 seconds
fetchSensorData();
setInterval(fetchSensorData,10000);

// PWA Service Worker
if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
        navigator.serviceWorker.register('service-worker.js').then(reg=>{
            console.log('Service Worker Registered', reg);
        }).catch(err=>console.log('SW Registration Failed:', err));
    });
}
</script>
</body>
</html>
